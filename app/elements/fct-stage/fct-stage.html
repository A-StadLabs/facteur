<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/geo-location/geo-location.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-signin/google-signin.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-element.html">


<!-- Our components -->
<link rel="import" href="../../elements/fct-letterhead/fct-letterhead.html">
<link rel="import" href="../../elements/fct-letter/fct-letter.html">

<polymer-element name="fct-stage" attributes="">
  <template>
    <link rel="stylesheet" href="fct-stage.css">

    <google-signin width="iconOnly" clientId="759839009338-n80siiikg3977u0qn277ebctn5s3pbgt.apps.googleusercontent.com" scopes="profile" id="gsign"></google-signin>

    <firebase-element id="base" on-data-change="{{handleResponse}}" keys="{{keys}}" data="{{data}}" location="https://facteur.firebaseio.com/posts/"></firebase-element>

    <geo-location watchpos highAccuracy id="geolocation" longitude="{{longitude}}" latitude="{{latitude}}"></geo-location>

    <google-map map="{{map}}" zoom="17"  latitude="{{latitude}}" disableDefaultUI draggable="false" longitude="{{longitude}}" id="googlemap">
      
      <template repeat="{{ key in keys }}">
        <google-map-marker latitude="{{data[key].latitude}}" longitude="{{data[key].longitude}}"></google-map-marker>
      </template>
    </google-map> 

    <core-selector valueattr="letter" id="letterselect">
      <template id="letterheads" repeat="{{l, i in inhoud}}">
        <fct-letterhead letter="{{l}}" key="{{l.key}}"></fct-letterhead>
      </template>
    </core-selector>

    <core-overlay id="overlay">
    <h1>Kiki Stanck</h1>
        <fct-letter letter="" id="fctletter"></fct-letter>
    </core-overlay>



  </template>
  <script>
    (function () {
      'use strict';

      var berichten = [];
      var latitude = '';
      var longitude = '';
      var afstand = '';

      var oldLongitude = '';
      var oldLatitude = '';

      var locationPaused = false;

      document.addEventListener("google-signin-success", function(e) {
        // Access the GAPI instance passed back from authorization
        var gapi = e.detail.gapi;

        // Load V1 of the G+ API
        gapi.client.load('plus', 'v1', function() {
            // To retreive profile information for a user, use the
            // people.get API method. For profile info for the currently
            // authorized user, use the userId value of me.
            var request = gapi.client.plus.people.get({
                'userId': 'me'
            });

            request.execute(function(resp) {
                // Some useful profile information is now available
                // via the returned object (resp). For example, we
                // can discover the displayName, skills and so on.
                //console.log(resp);

                // // This data can then be rendered into a template:
                // var t = document.querySelector("#profile");
                // t.model = {};
                // t.model.profile = resp;
            });
        });
        // document.querySelector("#status").innerHTML = "You are now signed in.";
        console.log('you are now signed in.');
      });

      function deg2rad(deg) {
        return deg * (Math.PI/180)
      }

      Polymer({
        // define element prototype here
        CalculateDistance: function(lat1,lon1,lat2,lon2) {
          var R = 6371; // Radius of the earth in km
          var dLat = deg2rad(lat2-lat1);  // deg2rad below
          var dLon = deg2rad(lon2-lon1); 
          var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2)
            ; 
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          var d = R * c; // Distance in km
          return d;
        },

        ready: function(){ 

        var userobject = {};
        var that = this;

        this.$.geolocation.addEventListener('geo-response', function(e) {
            latitude = e.detail.latitude;
            longitude = e.detail.longitude;

            afstand = that.CalculateDistance(latitude, longitude, oldLatitude, oldLongitude);

            if(afstand>0.003){
              if(!locationPaused){
                this.fire('poschanged');
                console.log('Je hebt je verplaatst met ',afstand);
                oldLatitude = latitude;
                oldLongitude = longitude;
              }
            }
          });

          document.addEventListener('poschanged', function(){
            that.handleResponse();
          });

          this.$.letterselect.addEventListener('core-select', function(e){
            console.log('er is iet geselecteerd: ', this.selected);
            that.$.fctletter.letter = this.selected;
            that.$.overlay.open();
          });

          this.$.fctletter.addEventListener('close', function(){
            that.$.overlay.close();
          });
      },

        handleResponse: function(e){
          var berichten = [];
          var t = this.$.letterheads;
          console.log(t);
          t.model = {inhoud: berichten};
          for (var i = this.keys.length - 1; i >= 0; i--) {
            var j = this.keys[i];
            // Afstand berekenen
            afstand = this.CalculateDistance(latitude, longitude, this.data[j].latitude, this.data[j].longitude);
            console.log('afst. ',afstand);
            if(afstand <= 0.03){
              berichten.push({'afstand': afstand, 'key': j, 'data': this.data[j]});
            };
          };
          berichten.sort(function(a,b){ return a.afstand - b.afstand});
        }
      });

    })();
  </script>
</polymer-element>
